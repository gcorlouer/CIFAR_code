%% Preprocess data with noisetool

% Parameters

subject = 'AnRa';
task = 'rest_baseline_1';
ext = '_bad_chans_removed.mat';
BP = false;
fs = 500;

% Preprocessing parameters


w = [];
basis = 'polynomials';
thresh = 5;
niter = 3;

%% Load data 

datadir = cf_datadir('subject', subject);
[fname, dataset] = CIFAR_filename('subject', subject, 'task',task, ... 
    'ext', ext, 'BP',BP);
fpath = fullfile(datadir, fname);

data = load(fpath);

X = data.time_series;

[nchans, nobs] = size(X);

%% Detrend

x = X';

order = 1;
[y,w,r]=nt_detrend(x,order,w,basis,thresh,niter);
%% Outlier removals 

[w,y]=nt_outliers(y,w,thresh,niter);
nsample = nchans*nobs;
noutl = nsample-sum(w, 'all');
outlier_fraction = noutl/nsample*100;
disp(outlier_fraction)

%% Rereference by weighted mean

[y,mn]=nt_rereference(y,w);

%% Demean

w =[];

[y,mn]=nt_demean(y,w);

%% Plot psd
X_p = y';
[S,f,nwobs,nobs,nwins] = tsdata_to_cpsd(X_p,fs,[],[],[],true);
plot_autocpsd(S,f,fs,nchans);

%% Save file

ext2save = '_preprocessed.mat';
fname2save = [dataset,ext2save];
fpath2save = fullfile(datadir, fname2save);
save(fpath2save, 'X_p')